version: 1
backend:
  phases:
    build:
      commands:
        - npm ci
        - export AMPX_APP_ID="${AMPLIFY_APP_ID:-$AWS_APP_ID}"
        - |
          if [ -z "$AMPX_APP_ID" ]; then
            echo "Missing Amplify app id. Set AMPLIFY_APP_ID or rely on AWS_APP_ID."
            exit 1
          fi
        - npx @aws-amplify/backend-cli pipeline-deploy --branch "$AWS_BRANCH" --app-id "$AMPX_APP_ID"
frontend:
  phases:
    preBuild:
      commands:
        - npm ci
    build:
      commands:
        - npm run build
  artifacts:
    baseDirectory: .next
    files:
      - "**/*"
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*
